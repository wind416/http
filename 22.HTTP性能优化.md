## HTTP性能优化

在HTTP的“请求-应答”模型上，可以优化的有三部分，客户端，服务端及中间的传输链路

##### 服务器

- 吞吐量(requests per second):简称RPS，每秒的请求次数，也叫TPS,QPS。RPS越高性能越好
- 并发数，反映服务器的负载能力，服务器能够同时支持的客户端数量，越多越好
- 响应时间:服务器处理能力，响应时间越短越好

测试工具:ab(Apache Bench)--------------Linux上,uptime,top,vmstat,netstart,sar-------Linux自带的

服务器的性能优化方向：合理利用系统资源，提高服务器的吞吐量和并发数，降低响应时间。

##### 客户端

- 延迟:等待数据到达客户端所花费的时间

  原因:

  - [ ] 物理距离
  - [ ] 带宽(电缆，Wifi，4G等)
  - [ ] DNS查询
  - [ ] TCP握手

- 测试网站:SSLLabs,WebPageTest,Chrome开发者工具

客户端 HTTP 性能优化的关键就是：降低延迟。

##### 传输链路

![HTTP性能优化传输链路](C:\Users\Admin\Desktop\极客时间小册\image\HTTP性能优化传输链路.png)

- "第一公里":指网站的出口，就是服务器接入互联网的传输线路，它的带宽直接决定了网站对外的服务能力，也就是吞吐量等指标。
- "中间一公里"：由小网络组成的实际互联网，是一个非常庞大的网络，但由于存在CDN实现代理，好像只有一公里。
- "最后一公里"：用户访问互联网的接口，对于固网用户就是光纤、网线，对于移动用户就是 WiFi、基站
- "第零公里": 就是网站内部的 Web 服务系统

最后一公里不能控制，只能通过增加带宽，降低延迟，优化传输速度来优化第零公里，第一公里，及中间一公里。

##### 优化方法

硬件软件，内部外部，花钱不花钱

花钱的手段有:投资购买现成硬件，花钱购买外部软件或服务

不花钱的有:

- 开源:抓“源头”，开发网站服务器自身的潜力(配置参数调用如HTTP用长连接,TCP用"TCP Fast Open"实现0-RTT)

- 节流:减少客户端与服务器之间的数据量，在有限的带宽传输更多内容

  - [ ] 数据压缩:使用`gzip`或`br`
  - [ ] 资源合并:对于小文本或小图片，把许多小资源合并成大资源，用一个请求全下载到客户端，客户端用JS,CSS切分后使用
  - [ ] 减少header大小，不必要字段不发
  - [ ] Cookie:浏览器每次访问网站都会带上Cookie，冗余度很高，所以应该尽量减少Cookie使用，减少Cookie记录的数据量
  - [ ] 收缩域名:域名解析耗费很大时间，最好将域名限制在两三个，减少解析完整域名所需时间
  - [ ] 重定向:重定向增加一次请求往返，增加时延，尽量不使用

- 缓存

  - [ ] 第零公里:网站系统内部用缓存
  - [ ] 中间一公里:CDN
  - [ ] 为资源添加ETag，Last-modified，max-age控制缓存属性

- 升级到HTTP/2(注意有些HTTP/1的优化手段不一定适用HTTP/2)

  HTTP/2不需要资源合并:HTTP/2有头部压缩和多路复用，传输小文件成本很低，不用合并，且资源合并会减低缓存可用性，当一个小文件更新，整个缓存都会失效

  HTTP/2中，一个域名使用一个TCP连接，开多个域名会浪费带宽和资源，所以需要域名压缩

