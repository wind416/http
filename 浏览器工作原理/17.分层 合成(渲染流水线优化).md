## 分层/合成

#### 显示图像过程

显示器每秒固定读取**前缓冲区(保存更新的图片)**的图像，并显示到显示器上。

##### 显卡

显卡合成新的图像，并将图像保存到后缓冲区后，前后缓冲区互换，包装显示器能读取到最新的图像。一般显卡的更新频率与显示器一致。

##### 帧/帧率

- 每一幅图片称为一帧
- 渲染流水线每秒更新多少帧称为帧率
- 当动画过程中，渲染引擎**更新一帧时间过久**会造成卡顿，需要优化。(使用分层合成机制)

#### 生成一帧图像

- 重绘:不需要计算布局树，重新计算绘制信息及之后

- 重排:重新计算`CSSOM`和`DOM`来计算布局树，花费时间多

- 合成:不触发布局和绘制阶段，当处理某些变换，如平移、 

  旋转、缩放、阴影或者`Alpha`渐变，合成器只需要将图层进⾏相应的变化操作就可以了，时间短

  - [ ] 分层:将素材分解为多个图层，生成布局树后，渲染引擎根据其特点转换为图层树(`Layer Tree`)

  - [ ] 分块:合成线程将每个图层分割为大小固定的图块，优先绘制靠近视口的图块，加速页面显示速度。

    但由于纹理上传即从计算机内存上传到`GPU`内存会很慢的问题，所以在首次合成会使用一个低分辨率的图片

  - [ ] 合成:将多个图层叠加在一起。按照绘制列表指令生成图片(光栅化)，每个图层对应一张图片，合成线程合成(不影响主线程执行)后送至后缓冲区。

  - [ ] 利用分层优化:**使用CSS来写动画效果，使用`will-change`属性提前告诉渲染引擎将该元素准备单独的层，变换时只需要用合成线程处理变换即可**，但内存占用会加大，因为从图层树开始每个阶段都会多一个层。

    ```css
    .box { will-change: transform, opacity; }
    ```

    如果用`JavaScript`处理动画，会导致重绘或重排，导致效率变慢。

#### 系统页面优化

- 加载阶段:发出请求到渲染出完整页面过程(网络及`js`脚本)

  关键资源:阻塞网页首次渲染的资源(首次请求的HTML资源，CSS文件，JavaScript文件)

  优化:

  - [ ] 减少关键资源个数
  - [ ] 减少关键资源大小
  - [ ] 减少关键资源的RTT(从发送数据到接收到反馈经过的往返时延)

- 交互阶段:页面加载完成到用户交互的整合过程(js脚本)

- 关闭阶段:用户发出关闭指令后页面所做的清理操作