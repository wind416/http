## 页面文件传输过程(TCP/HTTP)

FP(First Paint):页面加载到首次开始绘制的时长

影响FP的一个重要因素就是网络加载速度。

#### IP协议(网络协议):数据包通过IP地址发送信息给指定主机

数据包附加的主机B的IP地址，主机A的IP地址被装进IP头中

IP头+数据=数据包交给底层协议发送给对应的IP地址

#### UDP(用户数据包协议):把数据包送到应用程序

每个像访问网络的程序都绑定对应的端口号，**UDP通过端口号把数据包发给指定的应用程序**。

UDP由于不提供重传机制，不能保证数据可靠性，但传播速度很快

#### TCP协议:把数据完整的送到应用程序

TCP（Transmission Control Protocol，传输控制协议）是⼀种⾯向连接的、可靠的、基于字节流的传输层通信协议。

- TCP对于数据包丢失情况，提供重传机制
- TCP引入了数据包排序机制，用来把乱序数据包组成完整文件
- TCP头中包含目标端口号，本机端口号及排序的序列号

过程:

![TCP连接过程](C:\Users\Admin\Desktop\浏览器工作原理小册\image\TCP连接过程.png)

- [ ] 建立连接:通过三次握手建立客户端与服务器的连接。建立一个TCP连接时，客户端与服务器总共要发送三个数据包已确认连接建立

- [ ] 传输数据:**接收端对每个数据包进行确认操作，也就是接收端在接收到数据包 之后，需要发送确认数据包给发送端**。

  ⼀个⼤的⽂件在传输过程 中会被拆分成很多⼩的数据包，这些数据包到达接收端后，接收端会按照TCP头中的序号为其排序，从⽽组成完整的数据

- [ ] 断开连接:数据传输完，通过四次挥手断开连接

#### HTTP协议:浏览器向服务器获取资源的协议

过程:

- ##### 构建请求行信息(请求方法,URI,HTTP协议)，准备发起网络请求

- ##### 查找缓存

  发起请求前，会先在浏览器缓存中查找是否存有副本，有的话直接拦截请求，返回副本。

  优点:

  - [ ] 缓解服务器压力
  - [ ] 加快资源加载速度

- ##### 准备IP地址及端口号

  `HTTP`是建立在`TCP/IP`协议上的，在建立`HTTP`请求前，必须先建立TCP连接。即HTTP的内容是通过TCP的传输数据阶段来实现的。

  ![TCP HTTP关系](C:\Users\Admin\Desktop\浏览器工作原理小册\image\TCP HTTP关系.png)

  - [ ] 首先通过域名解析出IP地址及端口号
  - [ ] 由于每个域名只能建立6个TCP连接，若同一域名下有超过6的TCP连接，则进入TCP等待队列等待连接
  - [ ] 等待后，建立TCP连接

- ##### 发送HTTP请求(GET/POST)

  ![HTTP请求](C:\Users\Admin\Desktop\浏览器工作原理小册\image\HTTP请求.png)

- ##### 服务端处理HTTP请求

  - [ ] 返回响应报文

    ![响应报文](C:\Users\Admin\Desktop\浏览器工作原理小册\image\响应报文.png)

    响应行(协议版本号，状态码，原因)

    响应头(服务器信息)

    响应体(返回的数据)

  - [ ] 断开连接:服务器返回数据后一般会断开TCP连接，但当浏览器或服务器头字段加入`Connection:Keep-Alive`后，表明HTTP进行长连接，不用断开TCP连接，复用连接，提高资源加载速度

  - [ ] 补充:

    - 重定向:当返回状态码为`3xx`，表示返回的是重定向报文，浏览器收到后会根据`Location`字段的`URL`，自动发送HTTP请求，获取数据

- ##### 缓存:DNS缓存，页面资源缓存

  DNS缓存在浏览器端主要是把对应的IP和域名关联起来

  页面资源缓存：

  - [ ] 第一次请求服务器响应头包含`Control`字段来设置是否缓存该资源(`Cache-Control:Max-age=2000`)
  - [ ] 缓存未过期直接返回缓存的资源，过期后浏览器发送HTTP请求带上(`if-none-match`)判断资源是否更新
  - [ ] 未更新，浏览器返回304状态码，说明这个缓存可继续使用
  - [ ] 更新，直接返回最新资源给浏览器