## 消息队列/事件循环

消息队列和事件循环系统用来调度任务在**主线程**的执行

#### 单线程处理任务

将所有任务按顺序写入主线程，等线程执行时，任务会按顺序依次执行，执行完，线程自动退出。

![单线程处理任务](C:\Users\Admin\Desktop\浏览器工作原理小册\image\单线程处理任务.png)

#### 事件循环处理任务

在线程运行过程中，能够接收并执行新的任务，通过`for`监听是否有新任务。

```c++
//GetInput
//等待⽤⼾从键盘输⼊⼀个数字，并返回该输⼊的数字
int GetInput(){
    int input_number = 0;
    cout<<"请输⼊⼀个数:";
    cin>>input_number;//事件
    return input_number;
}
//主线程(Main Thread)
void MainThread(){
    for(;;){//循环监听任务
        int first_num = GetInput()；
        int second_num = GetInput()；
        result_num = first_num + second_num;
        print("最终计算的值为:%d",result_num)；
    }
}
```

#### 消息队列:处理其他线程发送的任务

消息队列:一种数据结构，可以存放要执行的任务。(**先进先出**)

##### `IO`线程:专门用来接受其他进程传进来的消息

渲染进程中的`IO`线程接收到其他**进程**用`IPC`传进来的消息后，将消息装成任务发送给渲染进程的主线程。

![跨进程发消息](C:\Users\Admin\Desktop\浏览器工作原理小册\image\跨进程发消息.png)

##### 实现从`IO`线程发送任务给主线程

- 添加消息队列

- `IO`线程产生的任务添加进消息队列尾部

- 主线程循环从消息队列头部读取任务

  ![消息队列和事件循环](C:\Users\Admin\Desktop\浏览器工作原理小册\image\消息队列和事件循环.png)

##### 任务类型

- 内部消息类型:输入事件，微任务，文件读写，`WebSocket`，`js`定时器
- 页面相关事件:`js`执行，解析`DOM`，样式计算，布局计算，`css`动画

##### 退出消息队列

页面主线程会设置一个退出标志的变量，每执行完一个任务，判断是否设置退出标志。设置了，就中断任务并退出

##### 缺点

由于消息队列先进先出的特征，会造成:

- 高优先级任务执行的效率与时效性

  当高优先级任务(如`DOM`变化),都调用相应js接口，执行时间会很长，效率会下降。若当作异步任务添加到消息队列尾部，会影响实时性。

  解决:

  - [ ] 宏任务:消息队列中的任务
  - [ ] 每个宏任务都包含一个微任务队列
  - [ ] 在执⾏宏任务的过程 中，如果DOM有变化，那么就会将该变化添加到微任务列表中，继续执行宏任务。(不影响效率)
  - [ ] 执行完宏任务，执行其中的微任务，然后才执行下一个宏任务(实时性)

- 单个任务执行时间过长