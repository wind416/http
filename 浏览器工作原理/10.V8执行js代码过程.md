## V8执行js代码过程

#### 编译器和解释器

编译型语言在程序执行前，需要经过编译器的编译，编译后直接保存二进制文件，下次直接运行二进制文件，不用重新编译。

- 编译器对源代码进行词法分析，语法分析，生成抽象语法树(`AST`)。
- 优化代码，生成机器码，编译成功，生成可执行文件(二进制文件)。
- 执行

解释型语言，**每次运行前都要通过解释器对程序进行动态解释和执行。**

- **解释器**对源代码进行词法分析，语法分析，生成`AST`。
- 生成字节码
- 执行

![编译器解释器执行过程](C:\Users\Admin\Desktop\浏览器工作原理小册\image\编译器解释器执行过程.png)



#### V8执行js代码(解释性语言)

![v8执行流程](C:\Users\Admin\Desktop\浏览器工作原理小册\image\v8执行流程.png)

1. ##### 生成抽象语法树(AST)与执行上下文

   将源代码转换成抽象语法树(`AST`)，并生成执行上下文。

   `AST`:**编译器**可以理解的语法结构(代码的结构化表示)，不管是编译型语言还是解释型语言都要生成。

   应用：

   - 在`Babel`中就是先将`ES6`语法生成`AST`,在将ES6语法的`AST`转换为`ES5`的语法的`AST`,最后再生成js源码。

   - `ESLint`(检测js编写规范的插件),检测流程是将源码转换为`AST`，利用`AST`来检测代码规范化。

   生成`AST`流程

   - [ ] 分词(词法分析):将源代码拆解成一个个`token`(语法上不能再分的,最小的单个字符或字符串)

     ![生成AST过程中拆解成token](C:\Users\Admin\Desktop\浏览器工作原理小册\image\生成AST过程中拆解成token.png)

   - [ ] 解析(语法分析):将`token`根据语法规则转换为`AST`。如果源码符合语法规则，成功。源码存在语法错误，抛出错误。

2. ##### 生成字节码

   **解释器**根据`AST`生成字节码，解释执行字节码。(介于`AST`与机器码之间的一种代码，通过解释器转换为机器码才能执行)

   由于保存机器码需要占有很大的内存空间，所以需要有字节码的存在。

   ![字节码占用空间小](C:\Users\Admin\Desktop\浏览器工作原理小册\image\字节码占用空间小.png)

3. ##### 执行代码

   解释器逐条解析执行，若遇到热点代码，进行即时编译。

   **即时编译(`JIT`)**:V8中

   - 执行字节码过程中，收集代码信息，若有一段代码被多次执行，即这段代码是热点代码。

   - **编译器(TurboFan)**就会把该段热点字节码转换为机器码保存起来。(优化)

   - 当再次执行这段代码时，直接执行其对应的机器码，提高执行效率。

   - 执行效率随着执行时间越长而越高，因为热点代码全转换为机器码保存起来了，但内存占用是个问题，需要权衡。

     ![即时编译技术](C:\Users\Admin\Desktop\浏览器工作原理小册\image\即时编译技术.png)

   

#### js性能优化

- 提高单次执行脚本的执行速度，避免长任务霸占主线程
- 避免大的内联脚本，解析HTML中，解析与编译也会占用主线程
- 减少js文件容量

