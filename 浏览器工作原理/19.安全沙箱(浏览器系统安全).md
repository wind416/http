## 安全沙箱(浏览器系统安全)

#### 安全问题

当浏览器爆出漏洞时，黑客可以通过恶意页面向浏览器注入恶意程序,攻击方式是利用缓冲区溢出。

这种攻击可以⼊侵到浏览器进程内部的，可以读取和修改浏览器进程内部的任意内容，**还可以穿透浏览器，在用户的操作系统上悄悄地安装恶意软件、监听用户键盘输⼊信息以及读取用户硬盘上的文件内容。**

#### 多进程架构(安全方面)

现代浏览器被分为浏览器内核和渲染内核两个模块

- 浏览器内核:浏览器主进程、网络进程、GPU进程组成
- 渲染内核:渲染进程(DOM解析,CSS解析,网络图片解码)
- 浏览器内核下载网络资源，通过IPC传递给渲染进程，渲染进程对资源进行解析、绘制等操作，最后将图片提交给浏览器内核模块，由浏览器内核显示图片

![多进程架构安全方面](C:\Users\Admin\Desktop\浏览器工作原理小册\image\多进程架构安全方面.png)

由于渲染进程需要DOM解析,CSS解析,网络图片解码等操作，如果其中存在系统级别漏洞，就会危害到操作系统的安全，**(由于浏览器内核只是进行下载未执行网络资源，所以没有危害)**，所以需要将渲染进程与操作系统隔离(安全沙箱)。

#### 安全沙箱

利用操作系统提供的安全技术，**让渲染进程在执行过程中无法访问或修改操作系统的数据**，当需要访问系统资源时，可以通过浏览器内核访问后通过`IPC`转发。

安全沙箱最小保护单位是进程，由于单进程浏览器需要频繁访问或修改操作系统数据，所以不能被安全沙箱保护。

由于收到安全沙箱保护，渲染进程中涉及到与系统交互的功能都必须转移至浏览器内核中。

- 持久储存

  由于渲染进程内部有访问`Cookie`的需求、有上传⽂件的需求。所以现代浏览器将读写⽂件的操作全部放在了浏览器内核中实现，然后通过`IPC`将操作结果转发给渲染进程

- 网络访问

- 用户交互

  通常，实现UI时，操作系统会提供一个页面供应用程序与用户交互,窗口句柄:`window:HWND`,`LINUX:X Window`。应用程序可以在窗口句柄上进行绘制和接受键盘消息。

  但现代渲染进程由于出于安全沙箱中，不能操作窗口句柄，这也**限制了渲染进程监控用户的输入事件。**

  解决:

  - [ ] 渲染进程需要渲染出位图
  - [ ] 操作系统需要将用户输入事件传给浏览器内核，浏览器内核判断当前焦点处于地址栏中，就有浏览器内核内部处理。如果焦点处于页面中，就转发给渲染进程处理。

#### 站点隔离

由于Chrome一开始石油标签页为单位划分渲染进程的，导致标签页中包含的`iframe`中可能会有不同站点的内容，由于操作系统有两个A级漏洞且很难修补，黑客可以通过漏洞对进程进行攻击，设置导致对操作系统进行攻击。如果`iframe`中有恶意内容，渲染进程会很容易被攻击。

所以`Chrome`限制将标签页渲染进程重构为`iframe`级的渲染进程，实现站点隔离。(**站点隔离:`Chrome`将同一站点(包含相同根域名和协议的地址)中相关联的页面放到同一渲染进程中执行。**)