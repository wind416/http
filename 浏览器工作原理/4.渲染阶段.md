## 渲染阶段

HTML:由标记和文本组成。

CSS(层叠样式表):选择器和属性组成。

JavaScript:是网页动起来

### 渲染流水线

渲染模块在执行过程中会被分为多个子阶段，输入的HTML通过这些字阶段，最后输出像素，这个过程叫做渲染流水线。

每个子阶段都有其输入的内容，处理过程和输出内容。

子阶段:

1. #### 构建DOM树

   由于浏览器无法直接理解和使用`HTML`，所以要将`HTML`(HTML解析器)转换成`DOM`树。

   ![渲染进程构建DOM树](C:\Users\Admin\Desktop\浏览器工作原理小册\image\渲染进程构建DOM树.png)

   通过在网页`console`控制台输入"`document`"查看DOM树结构，可以通过JS改变DOM树中的节点的内容。

2. #### 样式计算(Style)

   计算出DOM节点中每个元素的具体样式

   - [ ] 把CSS转换为浏览器能理解的结构:当渲染引擎接收到CSS文本时，会将其转换为`styleSheet`(可在控制台输入`document.styleSheet`查看)

   - [ ] 属性值标准化:由于CSS文本中很多属性值渲染引擎不理解，所以需要将值转换为渲染引擎易理解的、标准化的值

     ![渲染引擎标准化css属性值](C:\Users\Admin\Desktop\浏览器工作原理小册\image\渲染引擎标准化css属性值.png)

   - [ ] 计算DOM树中每个节点的具体样式(可通过`element>Computed`查看)

     - CSS继承规则：每个DOM节点都包含有父节点的样式(所有子节点都包含父节点的样式)

       ![css继承样式](C:\Users\Admin\Desktop\浏览器工作原理小册\image\css继承样式.png)

       `UserAgent`样式是浏览器的一组默认样式，当不提供样式时，默认使用`UserAgent`样式

     - **层叠规则**:定义了如何合并来自多个源的属性值的算法

3. #### 布局阶段:DOM树中可见元素的几何位置

   - 创建布局树:只包含可见元素

     ![渲染进程创建布局树过程](C:\Users\Admin\Desktop\浏览器工作原理小册\image\渲染进程创建布局树过程.png)

     浏览器遍历所有可见节点，并将这些节点添加到布局中，不可见节点会被忽略掉(`head,display:none`)

   - 布局计算:会把布局计算的结果重写回布局树

4. #### 分层(图层树)

   页面中有很多复杂的效果，为了实现这些，**渲染引擎需要为特定节点生成专用的图层，生成一颗总的图层树**(Chrome的Layers标签下可查看)

   ![图层树](C:\Users\Admin\Desktop\浏览器工作原理小册\image\图层树.png)

   并不是所有节点都包含一个图层，**如果某节点没有对应的图层，这个节点就从属于父节点的图层**，最后浏览器页面被分成很多图层，这些图层叠加后就形成最终页面。

   节点创建新图层的条件

   - 拥有层叠上下文属性的元素:层叠上下文(多个元素层叠在一个区域，需要放在不同图层)能够让HTML具有三维概念

     定位属性元素，透明属性，使用CSS滤镜属性都拥有层叠上下文属性(`position:fixed,z-index:2,filter:blue(5px),opacity:.5`)

   - 需要剪裁(`clip`)的地方:**当容器内的内容超出容器的长宽**,会出现剪裁，渲染引擎会把剪裁的部分作为显示，**被剪裁的内容(原文)出现在单独一层**,如果有滚动条，滚动条也被提升为单独的层

     ![剪裁的内容新建图层](C:\Users\Admin\Desktop\浏览器工作原理小册\image\剪裁的内容新建图层.png)

5. #### 图层绘制(图块栅格化)

   渲染引擎把图层拆分成很多的绘制指令，把指令按照顺序组成一个待绘制列表(Layers>document)

   **实际的绘制操作是在渲染引擎的合成线程完成的**。即渲染进程的主线程完成绘制列表并提交给合成线程。

   ##### 栅格化

   视口:用户能看到的页面大小

   由于在有些图层很大的页面上(很长)，用户只能看到页面视口部分，绘制出图层所有内容，会产生很大开销，所以合成线程会将图层划分成图块。

   - 合成线程生成图块(256×256/512×512)

   - 根据视口附近的**图块来优先生成位图(栅格化)**，渲染进程维护了一个栅格化线程池，图块栅格化都在线程池执行。

     ![栅格化过程](C:\Users\Admin\Desktop\浏览器工作原理小册\image\栅格化过程.png)

   - 栅格化通过`GPU`加速生成(快速栅格化)，生成的位图保存在`GPU`内存中。实现了跨进程操作。

   - 渲染进程把生成图块指令发给`GPU`，在`GPU`中执行生成图块的位图

     ![GPU栅格化](C:\Users\Admin\Desktop\浏览器工作原理小册\image\GPU栅格化.png)

6. #### 合成和显示

   一但所有图块都被光栅化，**合成线程**就会生成一个绘制图块的命令"`DrawQuad`",将其提交给**浏览器进程**。

   浏览器的`viz`组件，接受合成线程发来的"`DrawQuad`"命令，根据"`DrawQuad`"命令将页面内容绘制到内存中，最后将内存显示在屏幕上。

7. #### 总结

   ![渲染流水线总过程](C:\Users\Admin\Desktop\浏览器工作原理小册\image\渲染流水线总过程.png)

- 渲染进程将HTML转换为DOM树结构
- 渲染引擎将CSS样式表转换成styleSheets，计算出DOM节点样式。
- 创建布局树，计算元素布局信息
- 对布局树进行分层，建立图层树
- 为每个图层生成绘制列表，并提交到合成线程
- 合成线程将图层分成图块，并在光栅化线程池将图块转换成位图
- 合成线程发送绘制图块命令"`DrawQuad`"给浏览器进程
- 浏览器进程根据"`DrawQuad`"消息生成页面，显示到显示器上。