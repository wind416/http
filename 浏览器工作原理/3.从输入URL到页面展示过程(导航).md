## 从输入URL到页面展示过程

![从输入URL到页面展示](C:\Users\Admin\Desktop\浏览器工作原理小册\image\从输入URL到页面展示.png)

##### 浏览器进程:用户交互、子进程管理、文件储存(见1.浏览器进程)

##### 网络进程:面向渲染进程和浏览器进程等提供网络下载功能(见1.浏览器进程)

##### 渲染进程:把从网络下载的HTML\JavaScript\CSS图片等资源解析成可以显示和交互的页面。(由于获取的资源不一定安全，所以渲染进程要运行在沙箱里)(见1.浏览器进程)

#### 导航:从用户发出URL到页面开始解析的过程

##### 1.用户输入

用户在地址栏输入关键字后，浏览器的地址栏根据输入内容是否是URL

- 如果输入内容是搜索内容，地址栏会使用浏览器默认的搜索引擎，合成带搜索关键字的URL
- 如果输入内容符合URL规则，地址栏会根据规则，把内容加上协议成为完整的URL

##### 2.URL请求过程(网络进程中)

浏览器会通过进程间通信(IPC)把URL请求发送至网络进程。

网络进程收到URL请求后，会在这里发起真正URL请求流程

1. 查找本地缓存是否缓存了该资源，缓存了直接返回给浏览器进程，未缓存则进入网络请求

2. 进行DNS缓存查询，DNS解析获取服务器IP地址，利用IP地址进行TCP连接(TLS连接)

3. 连接建立后,浏览器构建请求信息(请求行,请求头,与该域名相关Cookie),发送

4. 服务器收到后，生成响应报文，并发送给网络进程

5. 网络进程收到响应报文后，**解析响应头，发现其状态码是301/302，即需要重定向。网络进程会从响应头的`Location`字段提取 URL，重新发送请求报文**。如果返回的是200，表示浏览器可以继续处理请求。

6. 成功收到响应数据后，浏览器通过HTTP头的`Content-Type`字段判断响应体的数据类型

   ```http
   HTTP/1.1 200 OK
   ....
    //返回的是HTML格式的内容
   Content-Type:text/html
   //返回数据是字节流类型，通常通过下载类型来处理
   Content-Type:application/octet-stream 
   ```

   当`Content-Type`配置错误时，浏览器可能会曲解文件内容，⽐如将`text/html`类型配置成`application/octet-stream`类型

   不同的`Content-Type`字段值有不同的处理流程

   - 下载类型(application/octet-stream ),该请求会被提交到浏览器的下载管理器，URL的请求导航结束
   - HTML，浏览器继续导航流程

##### 3.准备渲染进程(浏览器进程中)

同一站点:根域名(还包括该根域名下的子域名和不同端口)+协议都相同

```HTTP
//以下都属于同一站点
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```

- 通常情况，打开新页面都会创建单独的渲染进程。
- **如果A页面打开B页面，且A、B页面属于同一站点**，B页面复用A页面的渲染进程。如果其他情况，新创建一个渲染进程。

##### 4.提交文档(浏览器进程发出，渲染进程接收)

当渲染进程准备好后，就进入提交文档阶段

- 浏览器进程发出"提交文档"消息，渲染进程收到"提交文档"消息后**，会与网络进程建立传输数据的管道**

- 等文档数据传输完成后，渲染进程会返回"**确认提交**"消息给浏览器进程

- 浏览器收到消息后，**会更新浏览器界面状态(安全状态、地址栏URL，前进后退的历史状态，更新Web页面)**，导航流程结束

  ![提交文档阶段更新](C:\Users\Admin\Desktop\浏览器工作原理小册\image\提交文档阶段更新.png)

导航全过程:

1. 用户输⼊url并回车
2. 浏览器进程检查url，组装协议，构成完整的url 
3. 浏览器进程通过进程间通信（IPC）把url请求发送给⽹络进程
4.  网络进程接收到url请求后检查本地缓存是否缓存了该请求资源，如果有则将该资源返回给浏览器进程 
5. 如果没有，网络进程向web服务器发起http请求（⽹络请求），请求流程如下： 
   - 进行DNS解析，获取服务器ip地址，端口(端⼝是通过dns解析获取的吗？这⾥有个疑问） 
   - 利用ip地址和服务器建⽴tcp连接 
   - 构建请求头信息
   - 发送请求头信息
   -  服务器响应后，⽹络进程接收响应头和响应信息，并解析响应内容 
6. ⽹络进程解析响应流程；
   -   检查状态码，如果是301/302，则需要重定向，从`Location`⾃动中读取地址，重新进⾏第4步 ，如果是200，则继续处理请求。
   -  200响应处理： 检查响应类型`Content-Type`，如果是字节流类型，则将该请求提交给下载管理器，该导航流程结束，不再进行后续的渲染。如果是`HTML`则通知浏览器进程准备渲染进程准备进⾏渲染。
7.  准备渲染进程 
   - 浏览器进程检查当前`url`是否和之前打开的渲染进程根域名是否相同。如果相同，则复⽤原来的进程。 如果不同，则开启新的渲染进程。
8. 传输数据、更新状态 
   -  渲染进程准备好后，浏览器向渲染进程发起“提交⽂档”的消息，渲染进程接收到消息和网络进程建立传输数据的“管道”。
   -  渲染进程接收完数据后，向浏览器发送“确认提交”。
   - 浏览器进程接收到确认消息后更新浏览器界⾯状态：安全、地址栏url、前进后退的历史状态、更新Web页面。

